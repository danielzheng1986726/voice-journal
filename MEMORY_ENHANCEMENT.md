# Agentic Retriever 与 AI 记忆增强

## 📋 更新摘要

本次更新增强了 Agentic Retriever 的对话历史管理和上下文理解能力，使 AI 能够更好地理解多轮对话中的上下文，提供更智能的检索和回答。

## ✅ 已完成的功能

### 1. 对话历史管理

#### Web 界面支持 (`app.py`)
- ✅ 添加了 `conversation_id` 和 `conversation_history` 字段到 `ChatRequest` 和 `ChatResponse`
- ✅ 实现了服务器端对话历史存储（内存中，按 `conversation_id` 管理）
- ✅ 支持客户端和服务器端两种对话历史管理方式
- ✅ 自动限制对话历史长度（保留最近20条消息，即10轮对话）

#### Web 界面前端增强
- ✅ 添加了对话历史的本地存储（localStorage）
- ✅ 支持页面刷新后恢复对话历史
- ✅ 添加了"清空对话"按钮
- ✅ 改进了消息显示，支持换行显示

#### API 端点
- ✅ `GET /conversations/{conversation_id}` - 获取指定对话的历史
- ✅ `DELETE /conversations/{conversation_id}` - 删除指定对话的历史
- ✅ `GET /stats` - 添加了对话统计信息（活跃对话数、总消息数）

### 2. 上下文理解增强

#### System Prompt 增强 (`main.py`)
- ✅ 在 System Prompt 中添加了对话历史上下文摘要
- ✅ 提取最近3轮对话（6条消息）的关键信息
- ✅ 指导 AI 理解代词和省略主语的情况
- ✅ 添加了基于对话历史的查询优化说明

#### 查询重写功能
- ✅ 实现了 `rewrite_query_with_context()` 函数
- ✅ 基于对话历史优化查询关键词
- ✅ 自动识别代词（"它"、"那个"、"这个"、"那天"等）并补充上下文
- ✅ 在检索前自动应用查询重写

### 3. 检索策略优化

#### 多轮检索支持
- ✅ 在 System Prompt 中添加了多轮检索策略说明
- ✅ AI 可以在第一次检索结果不理想时，自动发起第二次检索
- ✅ 支持使用不同的查询词或更宽泛的日期范围进行二次检索

#### 检索结果增强
- ✅ 在检索结果中显示相似度分数（distance）
- ✅ 改进了结果格式化，便于 AI 理解

## 🔧 技术实现细节

### 对话历史存储结构

```python
conversation_histories: Dict[str, List[Dict[str, str]]] = {}
# 格式: {
#   "conversation_id": [
#     {"role": "user", "content": "..."},
#     {"role": "assistant", "content": "..."},
#     ...
#   ]
# }
```

### 查询重写流程

1. AI 生成 ACTION 指令（包含原始查询）
2. `rewrite_query_with_context()` 分析对话历史
3. 如果查询包含代词或过短，从历史中提取上下文信息
4. 优化后的查询发送到检索服务

### 上下文摘要生成

- 提取最近6条消息（3轮对话）
- 每条消息保留前200字符
- 在 System Prompt 中展示，帮助 AI 理解上下文

## 📊 使用示例

### 示例1：多轮对话中的代词理解

**第一轮：**
```
用户: 2024年6月2日我在做什么？
AI: [检索并回答]
```

**第二轮：**
```
用户: 那天的天气怎么样？
AI: [理解"那天"指的是2024年6月2日，自动检索该日期的天气信息]
```

### 示例2：对话历史持久化

- Web 界面使用 localStorage 保存对话历史
- 页面刷新后自动恢复对话
- 支持清空对话重新开始

### 示例3：多轮检索

**第一次检索：**
```
用户: 我去年写的关于情绪管理的笔记
AI: [检索] 没有找到相关记录。让我尝试用不同的关键词再搜索一次...
ACTION: SEARCH query="情绪 管理 笔记" date="last_year"
```

## 🚀 性能优化

- ✅ 对话历史自动截断（最多20条消息）
- ✅ 上下文摘要只包含最近3轮对话
- ✅ 查询重写只在必要时执行
- ✅ 服务器端历史存储使用内存字典（快速访问）

## 📝 API 变更

### 新增请求字段

```json
{
  "message": "用户消息",
  "conversation_id": "可选，对话ID",
  "conversation_history": [
    {"role": "user", "content": "..."},
    {"role": "assistant", "content": "..."}
  ]
}
```

### 新增响应字段

```json
{
  "response": "AI回答",
  "message": "用户消息",
  "conversation_id": "对话ID",
  "conversation_history": [
    {"role": "user", "content": "..."},
    {"role": "assistant", "content": "..."}
  ]
}
```

## 🔮 未来优化方向

- [ ] 使用更复杂的 NLP 模型进行查询重写
- [ ] 添加对话历史的数据库持久化
- [ ] 实现对话历史的语义搜索
- [ ] 添加对话摘要功能（压缩长对话）
- [ ] 支持多用户对话隔离
- [ ] 添加对话历史的导出功能

## 📚 相关文件

- `app.py` - FastAPI 服务，包含对话历史管理
- `main.py` - Agent 主程序，包含上下文理解和查询重写
- `retriever.py` - 向量检索器（未修改）

## 🎯 总结

本次更新显著提升了 Agentic Retriever 的智能程度：

1. **上下文理解**：AI 现在能够理解多轮对话中的上下文，正确处理代词和省略
2. **对话记忆**：Web 界面和 API 都支持对话历史管理，提供连贯的对话体验
3. **智能检索**：查询重写和多轮检索策略提高了检索成功率
4. **用户体验**：对话历史持久化，页面刷新后不丢失对话

这些改进使得 Digital Twin 守护者能够更好地理解用户意图，提供更准确、更相关的回答。
